<c-container>
  <c-card class="mb-3">
    <c-card-body>
      @if (logItemRequest$() | withLoading | async; as logItemResponse) {
        @if (logItemResponse.loading) {
          <app-loading
            [center]="false"
            customText="Načítám záznam"
            [small]="true"
          />
        } @else if (!logItemResponse.value) {
          <c-alert color="warning" class="mb-0">
            <div class="d-flex align-items-center">
              <svg cIcon name="cilWarning" size="xl" class="me-2"></svg>
              Bohužel se nepodařilo načíst informace o záznamu.
            </div>
          </c-alert>
        } @else {
          <app-info-row key="ID" [value]="logItemResponse.value.id" />

          <app-info-row
            key="Vytvořeno"
            [value]="logItemResponse.value.createdAt | localeDatePipe"
          />

          <app-info-row
            key="Typ"
            [value]="mapLogType(logItemResponse.value.type)"
          />

          <div class="mt-2">
            @if (logItemResponse.value.guildId) {
              <app-info-row
                key="Server"
                [value]="
                  (logItemResponse.value.guildId | guildLookup | async) ?? ''
                "
              />
            }

            @if (logItemResponse.value.userId) {
              <app-info-row
                key="Uživatel"
                [value]="
                  (logItemResponse.value.userId | userLookup | async) ?? ''
                "
              />
            }

            @if (logItemResponse.value.channelId) {
              <app-info-row
                key="Kanál"
                [value]="
                  (logItemResponse.value.channelId | channelLookup | async) ??
                  ''
                "
              />
            }
          </div>
        }
      }
    </c-card-body>
  </c-card>

  <c-card class="mb-2">
    <c-card-body>
      @if (detailRequest$() | withLoading | async; as detailResponse) {
        @if (detailResponse.loading) {
          <app-loading
            [center]="false"
            customText="Načítám detail záznamu"
            [small]="true"
          />
        } @else if (!detailResponse.value) {
          <c-alert color="warning" class="mb-0">
            <div class="d-flex align-items-center">
              <svg cIcon name="cilWarning" size="xl" class="me-2"></svg>
              Bohužel se nepodařilo načíst detail záznamu.
            </div>
          </c-alert>
        } @else {
          @switch (detailResponse.value.type) {
            @case (1) {
              <ng-container
                [ngTemplateOutlet]="textDetail"
                [ngTemplateOutletContext]="{
                  data: detailResponse.value.data,
                  color: 'secondary',
                }"
              />
            }

            @case (2) {
              <ng-container
                [ngTemplateOutlet]="textDetail"
                [ngTemplateOutletContext]="{
                  data: detailResponse.value.data,
                  color: 'warning',
                }"
              />
            }

            @case (3) {
              <ng-container
                [ngTemplateOutlet]="textDetail"
                [ngTemplateOutletContext]="{
                  data: detailResponse.value.data,
                  color: 'danger',
                }"
              />
            }
          }

          @if ([7, 11, 13, 15, 24].includes(detailResponse.value.type)) {
            <ng-container
              [ngTemplateOutlet]="diffTable"
              [ngTemplateOutletContext]="{
                data: detailResponse.value.data,
                type: detailResponse.value.type,
              }"
            />
          }
        }
      }
    </c-card-body>
  </c-card>
</c-container>

<ng-template #textDetail let-data="data" let-color="color">
  <c-row>
    <c-col md="6">
      <app-info-row key="Aplikace" [value]="data.sourceAppName" />
      <app-info-row key="Zdroj" [value]="data.source" />
    </c-col>
  </c-row>

  <c-alert [color]="color" class="mb-0 mt-3">
    <pre class="mb-0">{{ data.text }}</pre>
  </c-alert>
</ng-template>

<ng-template #diffTable let-data="data" let-type="type">
  <table cTable class="mb-0" [small]="true" [striped]="true">
    <thead>
      <tr>
        <th>Položka</th>
        <th>Před</th>
        <th>Po</th>
      </tr>
    </thead>
    <tbody>
      @switch (type) {
        @case (7) {
          <ng-container
            [ngTemplateOutlet]="channelUpdatedDiff"
            [ngTemplateOutletContext]="{ data }"
          />
        }
      }
    </tbody>
  </table>
</ng-template>

<ng-template #channelUpdatedDiff let-data="data">
  @if (data.bitrate && data.bitrate.before != data.bitrate.after) {
    <tr>
      <th>Bitrate</th>
      <td>{{ data.bitrate.before | spacedNumber }} bps</td>
      <td>{{ data.bitrate.after | spacedNumber }} bps</td>
    </tr>
  }

  @if (data.flags && data.flags.before != data.flags.after) {
    <tr>
      <th>Příznaky</th>
      <td>
        {{ data.flags.before }} ({{ data.flags.before | asBitmaskString: 32 }})
      </td>
      <td>
        {{ data.flags.after }} ({{ data.flags.after | asBitmaskString: 32 }})
      </td>
    </tr>
  }

  @if (data.position && data.position.before != data.position.after) {
    <tr>
      <th>Pozice</th>
      <td>{{ data.position.before | spacedNumber }}</td>
      <td>{{ data.position.after | spacedNumber }}</td>
    </tr>
  }

  @if (data.slowMode && data.slowMode.before != data.slowMode.after) {
    <tr>
      <th>Slowmode</th>
      <td>{{ data.slowMode.before * 1000 | timespan }}</td>
      <td>{{ data.slowMode.after * 1000 | timespan }}</td>
    </tr>
  }

  @if (data.isNsfw && data.isNsfw.before != data.isNsfw.after) {
    <tr>
      <th>NSFW</th>
      <td>
        <app-checkbox
          checkboxId="isNsfw"
          [label]="''"
          [formControl]="data.isNsfw.before | asReadonlyFormControl"
        />
      </td>
      <td>
        <app-checkbox
          checkboxId="isNsfw"
          [label]="''"
          [formControl]="data.isNsfw.after | asReadonlyFormControl"
        />
      </td>
    </tr>
  }

  @if (data.topic && data.topic.before != data.topic.after) {
    <tr>
      <th>Popis</th>
      <td>{{ data.topic.before }}</td>
      <td>{{ data.topic.after }}</td>
    </tr>
  }

  @if (data.name && data.name.before != data.name.after) {
    <tr>
      <th>Název</th>
      <td>{{ data.name.before }}</td>
      <td>{{ data.name.after }}</td>
    </tr>
  }
</ng-template>
